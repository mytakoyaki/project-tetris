# ADR021: リアルタイム通信技術の選定

## ステータス
承認

## 日付
2024-12-25

## コンテキスト
ClaudeTetrisプロジェクトのPhase 6（リアルタイム機能）において、オンラインマルチプレイヤー機能を実現するためのリアルタイム通信技術の選定が必要となった。1v1マッチング、リアルタイムゲーム状態同期、チャット機能等を考慮した技術選択が求められている。

## 決定内容
- **リアルタイム通信技術としてSocket.ioを採用する**
- **サーバーサイドでSocket.ioサーバーを実装する**
- **クライアントサイドでSocket.io-clientを統合する**

## 理由

### Socket.io選択の理由
1. **豊富な機能**: ルーム管理、名前空間、イベント駆動型通信が標準提供
2. **信頼性**: 自動再接続、フォールバック機能、エラーハンドリングが優秀
3. **開発者体験**: 豊富なドキュメント、TypeScriptサポート、デバッグツール
4. **スケーラビリティ**: Redisアダプターによる水平スケーリング対応
5. **ブラウザ互換性**: 幅広いブラウザとデバイスに対応

### サーバーサイド実装の理由
1. **制御性**: ゲームロジックの完全制御が可能
2. **セキュリティ**: 不正行為の検知・防止が容易
3. **パフォーマンス**: 最適化されたゲーム状態管理
4. **統合性**: 既存のAPI Routesとの統合が容易

## 代替案の検討

### ネイティブWebSocket
- **メリット**: 軽量、標準技術、パフォーマンス優秀
- **デメリット**: 実装コスト高、機能制限、エラーハンドリング複雑

### Server-Sent Events (SSE)
- **メリット**: シンプル、HTTPベース、自動再接続
- **デメリット**: サーバーからクライアントへの一方向通信のみ

### WebRTC
- **メリット**: P2P通信、低レイテンシー、帯域幅効率
- **デメリット**: 実装複雑、NAT越え問題、セキュリティリスク

## 実装計画

### Phase 6A: Socket.io基盤構築
- [ ] Socket.ioサーバー実装
- [ ] クライアント統合
- [ ] 基本的な接続・切断処理
- [ ] エラーハンドリング

### Phase 6B: ゲームルーム機能
- [ ] ルーム作成・参加・退出
- [ ] プレイヤーマッチング
- [ ] ゲーム状態同期
- [ ] リアルタイムスコア更新

### Phase 6C: 高度な機能
- [ ] チャット機能
- [ ] スペクテーター機能
- [ ] リプレイ機能
- [ ] パフォーマンス最適化

## 技術的詳細

### サーバーサイド実装
```typescript
// server/socket.ts
import { Server } from 'socket.io';
import { createServer } from 'http';

const httpServer = createServer();
const io = new Server(httpServer, {
  cors: {
    origin: process.env.NEXT_PUBLIC_CLIENT_URL,
    methods: ["GET", "POST"]
  }
});

// ゲームルーム管理
io.on('connection', (socket) => {
  socket.on('join-room', (roomId) => {
    socket.join(roomId);
    // ルーム参加処理
  });
  
  socket.on('game-action', (data) => {
    // ゲームアクション処理
    socket.to(data.roomId).emit('game-update', data);
  });
});
```

### クライアントサイド統合
```typescript
// hooks/useSocket.ts
import { useEffect, useRef } from 'react';
import { io, Socket } from 'socket.io-client';

export const useSocket = () => {
  const socketRef = useRef<Socket>();

  useEffect(() => {
    socketRef.current = io(process.env.NEXT_PUBLIC_SOCKET_URL!);
    
    return () => {
      socketRef.current?.disconnect();
    };
  }, []);

  return socketRef.current;
};
```

## パフォーマンス考慮事項

### 接続管理
- 最大同時接続数: 1,000ユーザー
- 接続タイムアウト: 30秒
- ハートビート間隔: 10秒

### メッセージ最適化
- ゲーム状態更新: 60fps（16ms間隔）
- チャットメッセージ: 即座
- スコア更新: リアルタイム

### スケーリング戦略
- Redisアダプターによる水平スケーリング
- ルーム単位での負荷分散
- 地理的分散（CDN活用）

## セキュリティ対策

### 認証統合
- JWT/Clerk認証との統合
- ソケット接続時の認証確認
- 権限ベースのアクセス制御

### 不正防止
- レート制限
- メッセージサイズ制限
- 異常なアクション検知

## コスト見積もり

### インフラコスト
- **開発環境**: 無料（ローカル開発）
- **本番環境**: $20-50/月（小規模）
- **大規模運用**: $100-500/月（1万ユーザー）

### 開発コスト
- **実装工数**: 2-3週間
- **テスト工数**: 1週間
- **デバッグ工数**: 1週間

## リスクと対策

### 接続不安定性
- **リスク**: ネットワーク断線によるゲーム中断
- **対策**: 自動再接続、ゲーム状態復元機能

### パフォーマンス劣化
- **リスク**: 同時接続数増加時の遅延
- **対策**: 水平スケーリング、メッセージ最適化

### セキュリティリスク
- **リスク**: 不正なゲーム操作、DDoS攻撃
- **対策**: 認証強化、レート制限、監視体制

## 今後の課題
- Socket.ioサーバーの詳細設計
- ゲーム状態同期アルゴリズムの実装
- パフォーマンステストの実施
- セキュリティ監査の実施
- 監視・ログ体制の構築 