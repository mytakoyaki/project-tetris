# ADR-017: レーティングベースマッチングの段階的拡大

## ステータス
承認済み

## 日付
2024-12-25

## 決定者
プロジェクトチーム

## 技術的決定
パブリックマッチングでは、レーティング差の許容範囲を段階的に拡大する方式を採用する。

## 背景
スキルベースマッチングにおいて、適切な相手が見つからない場合の待機時間と、公平な対戦のバランスを取る必要がある。レーティング差の許容範囲を固定すると、待機時間が長くなる可能性がある。

## 検討された選択肢

### 選択肢1: 固定レーティング差
- **メリット**: 実装が簡単、常に公平な対戦
- **デメリット**: 待機時間が長くなる可能性、マッチング失敗率の増加

### 選択肢2: 段階的拡大（採用）
- **メリット**: 待機時間と公平性のバランス、マッチング成功率の向上
- **デメリット**: 実装がやや複雑、後半の対戦は不公平になる可能性

### 選択肢3: 完全ランダム
- **メリット**: 即座にマッチング、実装が簡単
- **デメリット**: 不公平な対戦、ユーザー体験の悪化

## 決定理由
1. **ユーザー体験の向上**: 適切な待機時間でのマッチング
2. **マッチング成功率**: 段階的拡大による成功率向上
3. **公平性の維持**: 初期段階では公平な対戦を優先
4. **実装の実現性**: 複雑すぎない実装で実現可能

## 段階的拡大の詳細

### 初期設定
- **開始時**: ±200以内
- **30秒後**: ±300以内
- **60秒後**: ±500以内
- **90秒後**: ±1000以内
- **120秒後**: 制限なし（ランダムマッチング）

### レーティング計算（ELO）
```typescript
interface RatingUpdate {
  userId: string;
  oldRating: number;
  newRating: number;
  opponentRating: number;
  result: 'win' | 'lose' | 'draw';
  gameMode: string;
}
```

### マッチング条件
- **ゲームモード**: 同一モードでのマッチング
- **オンライン状態**: アクティブなプレイヤーのみ
- **地域**: 将来的に地域ベースマッチングも検討

## 影響
- マッチング待機時間の短縮
- 初期段階での公平な対戦
- 後半段階での不公平な対戦の可能性
- 実装の複雑性の増加

## 実装方針
- マッチングキューでの待機時間管理
- 段階的なレーティング差制限の適用
- マッチング成功時の即座なルーム作成
- マッチング失敗時の再試行ロジック
- ユーザーへの待機状況表示 