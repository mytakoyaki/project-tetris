# ADR020: 認証・キャッシュ技術の選定

## ステータス
承認

## 日付
2024-12-25

## コンテキスト
ClaudeTetrisプロジェクトのPhase 4B（データベース統合）において、認証システムとキャッシュ技術の選定が必要となった。現在はJWTベースの認証を実装済みだが、将来的なSNSログイン対応とUI/UXの向上を考慮した技術選択が求められている。

## 決定内容
- **認証技術としてClerkを採用する**
- **キャッシュ技術としてRedis（Upstash）を採用する**
- **段階的移行戦略を採用し、現在のJWT認証からClerkへの移行をPhase 5で実施する**

## 理由

### Clerk選択の理由
1. **UI/UX重視**: 美しい認証UIコンポーネントが標準で提供され、開発速度が大幅に向上
2. **開発者体験**: TypeScriptサポート、豊富なドキュメント、Next.js統合が優秀
3. **セキュリティ**: 多要素認証、パスワードレス認証、不正検知機能が標準搭載
4. **SNSログイン対応**: Google、GitHub、Discord等の主要SNSプロバイダーが簡単に統合可能
5. **スケーラビリティ**: マネージドサービスによりインフラ管理が不要

### Redis選択の理由
1. **高速性**: インメモリキャッシュによる高速なデータアクセス
2. **多機能**: セッション管理、ランキングデータ、ゲームルーム情報の保存に適している
3. **リアルタイム対応**: 将来的なSocket.io統合時の状態管理に最適
4. **コスト効率**: Upstashの従量課金モデルにより初期コストを抑制

### 段階的移行戦略の理由
1. **リスク軽減**: 現在のJWT認証を維持しながら段階的に移行
2. **開発継続**: 既存機能の開発を中断することなく移行可能
3. **学習時間**: チームのClerk学習時間を確保

## 代替案の検討

### NextAuth.js + Redis
- **メリット**: 無料、完全制御、カスタマイズ自由
- **デメリット**: 実装コスト高、UI開発工数大、セキュリティ責任

### Supabase Auth + Supabase
- **メリット**: 無料枠充実、オープンソース
- **デメリット**: UI制限、機能制限、学習コスト

### 現在のJWT + インメモリキャッシュ
- **メリット**: 軽量、完全制御
- **デメリット**: スケーラビリティ不足、UI開発工数大

## 実装計画

### Phase 4B: データベース統合
- [ ] Prisma + PostgreSQL設定
- [ ] Redis（Upstash）設定
- [ ] 現在のJWT認証を維持

### Phase 5: Clerk認証移行
- [ ] Clerkプロジェクト設定
- [ ] 認証UIコンポーネント実装
- [ ] SNSログイン統合
- [ ] JWT認証からの段階的移行

### Phase 6: リアルタイム機能
- [ ] Socket.io統合
- [ ] Redis活用したゲームルーム管理
- [ ] リアルタイムランキング

## コスト見積もり

### Clerk料金（月額）
- **初期**: Free（月5,000アクティブユーザーまで）
- **成長期**: Pro $25（月25,000アクティブユーザーまで）
- **本格運用**: Business $99（月100,000アクティブユーザーまで）

### Redis料金（Upstash）
- **初期**: Free（日10,000リクエストまで）
- **成長期**: Pay-as-you-go $0.20/100万リクエスト

## リスクと対策

### ベンダーロックイン
- **リスク**: Clerk固有のAPIに依存
- **対策**: 抽象化レイヤーの実装、移行計画の準備

### コスト増加
- **リスク**: ユーザー増加時の料金上昇
- **対策**: 使用量監視、コスト最適化の継続

### 外部依存
- **リスク**: 外部サービス障害の影響
- **対策**: フォールバック機能の実装、監視体制の構築

## 今後の課題
- Clerkの学習・習熟
- 認証フローの設計詳細
- データ移行計画の策定
- セキュリティ監査の実施
- パフォーマンス監視の設定 