# スピン技判定・SRS仕様書

## 概要

本ドキュメントは、Modern Tetrisにおける各スピン技の判定基準とSRS（Super Rotation System）の仕様を定義します。公式のTTC（Tetris Guideline）に準拠した実装を行います。

## SRS（Super Rotation System）

### 基本概念

SRSは、テトリミノの回転時に壁や他のブロックに衝突した場合、自動的に位置を調整するシステムです。

### キックテーブル

#### 標準テトリミノ（T, S, Z, J, L）

| 回転 | キックオフセット |
|------|------------------|
| 0→1  | (0,0), (-1,0), (-1,1), (0,-2), (-1,-2) |
| 1→0  | (0,0), (1,0), (1,-1), (0,2), (1,2) |
| 1→2  | (0,0), (1,0), (1,-1), (0,2), (1,2) |
| 2→1  | (0,0), (-1,0), (-1,1), (0,-2), (-1,-2) |
| 2→3  | (0,0), (1,0), (1,1), (0,-2), (1,-2) |
| 3→2  | (0,0), (-1,0), (-1,-1), (0,2), (-1,2) |
| 3→0  | (0,0), (-1,0), (-1,-1), (0,2), (-1,2) |
| 0→3  | (0,0), (1,0), (1,1), (0,-2), (1,-2) |

#### Iミノ専用キックテーブル

| 回転 | キックオフセット |
|------|------------------|
| 0→1  | (0,0), (-2,0), (1,0), (-2,-1), (1,2) |
| 1→0  | (0,0), (2,0), (-1,0), (2,1), (-1,-2) |
| 1→2  | (0,0), (-1,0), (2,0), (-1,2), (2,-1) |
| 2→1  | (0,0), (1,0), (-2,0), (1,-2), (-2,1) |
| 2→3  | (0,0), (2,0), (-1,0), (2,1), (-1,-2) |
| 3→2  | (0,0), (-2,0), (1,0), (-2,-1), (1,2) |
| 3→0  | (0,0), (1,0), (-2,0), (1,-2), (-2,1) |
| 0→3  | (0,0), (-1,0), (2,0), (-1,2), (2,-1) |

### 回転処理

1. **基本回転**: テトリミノを90度回転
2. **衝突判定**: 回転後の位置で衝突をチェック
3. **キック試行**: 衝突した場合、キックテーブルの順序で位置調整を試行
4. **成功判定**: 最初に衝突しない位置が見つかった時点で成功
5. **失敗判定**: 全てのキックを試行しても衝突が解決しない場合は回転失敗

## スピン技判定基準

### 共通条件

- **ウォールキック必須**: 全てのスピン技でウォールキックの使用が必須
- **回転直後**: 回転動作直後のみ判定対象
- **ライン消去**: ライン消去がある場合のみ有効

### 1. T-Spin

#### 判定条件
- **テトリミノ**: Tミノのみ
- **角埋まり**: 中心4角のうち3つ以上が埋まっている
- **ウォールキック**: 必須

#### 中心位置
- **座標**: Tミノの形状テーブルの(1,1)位置
- **計算**: `(tetromino.x + 1, tetromino.y + 1)`

#### 角位置
```
左上: (中心x-1, 中心y-1)
右上: (中心x+1, 中心y-1)
左下: (中心x-1, 中心y+1)
右下: (中心x+1, 中心y+1)
```

#### 種別判定
- **T-Spin Normal**: 3-4角埋まり + 通常のキックパターン
- **T-Spin Mini**: 3角埋まり + 特定のキックパターン（kick_index > 0）

#### スコア
- **Single**: 2,000点
- **Double**: 5,000点
- **Triple**: 10,000点
- **Mini Single**: 1,000点
- **Mini Double**: 2,000点
- **Mini Triple**: 3,000点

### 2. S/Z-Spin

#### 判定条件
- **テトリミノ**: SミノまたはZミノ
- **角埋まり**: 中心4角のうち2つ以上が埋まっている
- **ウォールキック**: 必須

#### 中心位置
- **座標**: S/Zミノの形状テーブルの(1,1)位置
- **計算**: `(tetromino.x + 1, tetromino.y + 1)`

#### 角位置
```
左上: (中心x-1, 中心y-1)
右上: (中心x+1, 中心y-1)
左下: (中心x-1, 中心y+1)
右下: (中心x+1, 中心y+1)
```

#### スコア
- **Single**: 800点
- **Double**: 2,000点
- **Triple**: 4,000点

### 3. I-Spin

#### 判定条件
- **テトリミノ**: Iミノのみ
- **角埋まり**: 中心4角のうち2つ以上が埋まっている
- **ウォールキック**: 必須

#### 中心位置
- **座標**: Iミノの形状テーブルの(1,1)位置
- **計算**: `(tetromino.x + 1, tetromino.y + 1)`

#### 角位置（回転に応じて変化）

**横長（0度・180度）**:
```
左上: (中心x-2, 中心y-1)
右上: (中心x+2, 中心y-1)
左下: (中心x-2, 中心y+1)
右下: (中心x+2, 中心y+1)
```

**縦長（90度・270度）**:
```
左上: (中心x-1, 中心y-2)
右上: (中心x+1, 中心y-2)
左下: (中心x-1, 中心y+2)
右下: (中心x+1, 中心y+2)
```

#### スコア
- **Single**: 600点
- **Double**: 1,500点
- **Triple**: 3,000点

### 4. J/L-Spin

#### 判定条件
- **テトリミノ**: JミノまたはLミノ
- **角埋まり**: 中心4角のうち2つ以上が埋まっている
- **ウォールキック**: 必須

#### 中心位置
- **座標**: J/Lミノの形状テーブルの(1,1)位置
- **計算**: `(tetromino.x + 1, tetromino.y + 1)`

#### 角位置
```
左上: (中心x-1, 中心y-1)
右上: (中心x+1, 中心y-1)
左下: (中心x-1, 中心y+1)
右下: (中心x+1, 中心y+1)
```

#### スコア
- **Single**: 700点
- **Double**: 1,800点
- **Triple**: 3,500点

## ブロック埋め込み判定

### 判定ロジック

```rust
fn is_filled(x: i32, y: i32, field: &Field) -> bool {
    // フィールド外は埋まっている扱い
    if x < 0 || y < 0 || (x as u32) >= field.width || (y as u32) >= field.height {
        return true;
    }
    // フィールド内は実際のブロック有無で判定
    let idx = (y as u32 * field.width + x as u32) as usize;
    field.cells.get(idx).copied().unwrap_or(0) != 0
}
```

### 重要なポイント

1. **フィールド外**: 埋まっている扱い（壁や床として機能）
2. **フィールド内**: 実際のブロック有無で判定
3. **角位置**: 各ミノの形状に応じた中心位置から相対座標

## 実装例

### Rust側の統合判定関数

```rust
fn detect_spin(tetromino: &Tetromino, field: &Field, wallkick: bool, kick_index: i32, lines_cleared: u32) -> SpinResult {
    match tetromino.kind.as_str() {
        "T" => detect_t_spin(tetromino, field, wallkick, kick_index, lines_cleared),
        "S" | "Z" => detect_sz_spin(tetromino, field, wallkick, kick_index, lines_cleared),
        "I" => detect_i_spin(tetromino, field, wallkick, kick_index, lines_cleared),
        "J" | "L" => detect_jl_spin(tetromino, field, wallkick, kick_index, lines_cleared),
        _ => SpinResult { spin_type: SpinType::None, variant: SpinVariant::None, bonus: 0, lines: lines_cleared },
    }
}
```

### WASM API

```rust
#[wasm_bindgen]
pub fn detect_spin_wasm(
    tetromino: JsValue,
    field: JsValue,
    wallkick: bool,
    kick_index: i32,
    lines_cleared: u32,
) -> JsValue
```

## テストケース

### T-Spinテスト
- 3角埋まり + ウォールキック → T-Spin Normal
- 3角埋まり + 特定キック → T-Spin Mini
- 2角以下埋まり → スピンなし

### その他スピン技テスト
- 2角以上埋まり + ウォールキック → 対応するスピン技
- 1角以下埋まり → スピンなし
- ウォールキックなし → スピンなし

## 参考資料

- [Tetris Guideline](https://tetris.wiki/Tetris_Guideline)
- [SRS (Super Rotation System)](https://tetris.wiki/SRS)
- [T-Spin](https://tetris.wiki/T-Spin)
- [Modern Tetris README.md](../modern-tetris/README.md) 